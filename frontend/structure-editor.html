<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh sửa Cấu trúc - SlideGen</title>
    <script src="./config.js?v=2"></script> <!-- Load config -->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/structure-editor.css">
    <style>
        /* CRITICAL OVERRIDES */
        .slide-bullet {
            display: block !important;
            position: relative !important;
            padding-left: 1.2rem !important;
        }

        .slide-bullet::before {
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
        }

        .node-merged-content .btn {
            padding: 1px 5px !important;
            font-size: 0.75rem !important;
        }

        /*  */

        /* SELECTION CONTROLS - Better visibility */
        .form-label {
            color: #ffffff !important;
            font-weight: 600 !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .form-select {
            background-color: rgba(255, 255, 255, 0.95) !important;
            color: #1a1a1a !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            font-weight: 500 !important;
        }

        .form-select option {
            background-color: #ffffff !important;
            color: #1a1a1a !important;
        }

        #selectionPreview {
            background-color: rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }
    </style>
</head>

<body>
    <!-- Aurora Overlay -->
    <div class="aurora-overlay"></div>

    <!-- Particles -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Dark Mode Toggle Button -->
    <button class="theme-toggle" onclick="toggleDarkMode()" aria-label="Chuyển đổi chế độ tối">
        <i class="bi bi-moon-stars-fill icon moon-icon"></i>
        <i class="bi bi-sun-fill icon sun-icon"></i>
    </button>

    <div class="container-fluid px-4 py-3">
        <!-- Header -->
        <div class="header-section">
            <button class="btn btn-outline-light" onclick="goBack()">
                <i class="bi bi-arrow-left"></i> Quay lại
            </button>
            <h2 class="header-title">
                <i class="bi bi-diagram-3"></i> Chỉnh sửa Cấu trúc Thủ công
            </h2>
            <div class="document-info">
                <i class="bi bi-file-text"></i>
                <span id="documentTitle">Tài liệu</span>
            </div>
            <!-- Action Buttons in Header -->
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" onclick="resetStructure()">
                    <i class="bi bi-arrow-counterclockwise"></i> Đặt lại
                </button>
                <button class="btn btn-sm btn-danger" onclick="cancelEdit()">
                    <i class="bi bi-x-circle"></i> Hủy
                </button>
                <button class="btn btn-sm btn-success" onclick="approveAndContinue()">
                    <i class="bi bi-check-circle"></i> Duyệt & Tiếp tục
                </button>
            </div>
        </div>

        <!-- Main Content: 3-Column Layout -->
        <div class="row h-100 g-2">
            <!-- COLUMN 1: Document Text -->
            <div class="col-md-4 h-100">
                <div class="panel-container">
                    <div class="panel-header">
                        <h5><i class="bi bi-file-text"></i> Nội dung Tài liệu</h5>
                        <span class="text-muted small">Chọn văn bản để thêm</span>
                    </div>

                    <div class="document-text-container" id="documentTextContainer">
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-hourglass-split" style="font-size: 3rem;"></i>
                            <p class="mt-2">Đang tải tài liệu...</p>
                        </div>
                    </div>

                    <!-- Selection Controls -->
                    <div class="selection-controls" id="selectionControls" style="display:none;">
                        <div class="selected-text-preview" id="selectedTextPreview">
                            Chưa chọn văn bản nào
                        </div>
                        <div class="control-buttons">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Kiểu:</label>
                                    <select class="form-select form-select-sm" id="nodeType">
                                        <option value="title">Tiêu đề</option>
                                        <option value="content">Nội dung</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Cấp độ:</label>
                                    <select class="form-select form-select-sm" id="nodeLevel">
                                        <option value="0">L0 (Slide Giới thiệu)</option>
                                        <option value="1">L1 (Slide)</option>
                                        <option value="2">L2 (Điểm chính)</option>
                                        <option value="3">L3 (Phụ)</option>
                                        <option value="4">L4</option>
                                        <option value="5">L5</option>
                                        <option value="6">L6</option>
                                        <option value="7">L7</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label">Cha:</label>
                                <select class="form-select form-select-sm" id="parentNode">
                                    <option value="">Gốc</option>
                                </select>
                            </div>
                            <button class="btn btn-primary btn-sm w-100 mt-2" onclick="addSelectedToStructure()">
                                <i class="bi bi-plus-circle"></i> Thêm vào Cấu trúc
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMN 2: Structure Tree -->
            <div class="col-md-4 h-100">
                <div class="panel-container">
                    <div class="panel-header">
                        <h5><i class="bi bi-diagram-3"></i> Cấu trúc Tài liệu</h5>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-primary" onclick="showAddNodeForm()"
                                title="Thêm Node Thủ công">
                                <i class="bi bi-plus-circle"></i> Thêm
                            </button>
                            <span class="badge bg-info" id="nodeCount">0 mục</span>
                        </div>
                    </div>

                    <!-- Intro Slide Section -->
                    <div class="intro-slide-section mb-3 p-2">
                        <button class="btn btn-sm btn-info w-100" onclick="openIntroSlideModal()" id="introSlideBtn">
                            <i class="bi bi-plus-lg"></i> Thêm Slide Giới thiệu (Level 0)
                        </button>
                        <div id="introSlidePreview" style="display:none;"
                            class="mt-2 p-2 bg-info bg-opacity-25 rounded">
                            <small class="text-muted">Slide Giới thiệu (Level 0):</small>
                            <div id="introSlideText" class="text-white small mt-1"></div>
                            <button class="btn btn-xs btn-warning btn-sm mt-2" onclick="editIntroSlide()">Sửa</button>
                            <button class="btn btn-xs btn-danger btn-sm mt-2" onclick="removeIntroSlide()">Xóa</button>
                        </div>
                    </div>

                    <div class="tree-container" id="treeContainer">
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">Chưa có cấu trúc. Chọn văn bản để bắt đầu.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMN 3: Slide Previews -->
            <div class="col-md-4 h-100">
                <div class="panel-container">
                    <div class="panel-header">
                        <h5><i class="bi bi-collection"></i> Xem trước Slide</h5>
                        <span class="badge bg-success" id="slideCount">0 slides</span>
                    </div>

                    <div class="slides-container" id="slidesContainer">
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-file-slides" style="font-size: 3rem;"></i>
                            <p class="mt-2">Slides sẽ hiện ở đây</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sửa Node</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Kiểu Node</label>
                            <select class="form-select" id="editNodeType">
                                <option value="title">Tiêu đề</option>
                                <option value="content">Nội dung</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cấp độ</label>
                            <select class="form-select" id="editNodeLevel">
                                <option value="1">Cấp độ 1</option>
                                <option value="2">Cấp độ 2</option>
                                <option value="3">Cấp độ 3</option>
                                <option value="4">Cấp độ 4</option>
                                <option value="5">Cấp độ 5</option>
                                <option value="6">Cấp độ 6</option>
                                <option value="7">Cấp độ 7</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Node Cha</label>
                            <select class="form-select" id="editParentNode">
                                <option value="">Gốc (Không có cha)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Nội dung Văn bản</label>
                            <textarea class="form-control" id="editNodeText" rows="8"></textarea>
                            <small class="text-muted">Số ký tự: <span id="editCharCount">0</span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveNodeEdit()">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Intro Slide Modal -->

    <div class="modal fade" id="introSlideModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm/Sửa Slide Giới thiệu (Level 0)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Tiêu đề/Nội dung Slide Giới thiệu</label>
                            <textarea class="form-control" id="introSlideInput" rows="6"
                                placeholder="Nhập nội dung cho slide giới thiệu..."></textarea>
                            <small class="text-muted">Số ký tự: <span id="introCharCount">0</span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" onclick="saveIntroSlide()">Lưu Slide Giới
                        thiệu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="modal fade" id="customAlertModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle"></i> Thông báo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="customAlertMessage">
                    Message here
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div class="modal fade" id="customConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-question-circle"></i> Xác nhận hành động
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="customConfirmMessage">
                    Xác nhận hành động này?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-warning" id="customConfirmOk">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="js/structure-editor.js?v=2"></script> <!-- v2: Fixed config usage -->
</body>

</html>